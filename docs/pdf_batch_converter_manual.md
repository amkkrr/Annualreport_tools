# PDF批量下载转换器 用户手册

## 功能概述

`2.pdf_batch_converter.py` 提供两种模式：

1. **下载+转换模式（download）**：从巨潮资讯网下载PDF年报并转换为TXT（本手册主要覆盖）
2. **纯转换模式（convert_only）**：对本地目录中的PDF直接批量转换为TXT（见 `docs/convert_only_mode_user_guide.md`）

下载+转换模式主要功能：

1. **批量下载** - 从巨潮资讯网下载PDF年报
2. **格式转换** - 将PDF自动转换为TXT文本
3. **多进程处理** - 充分利用多核CPU加速处理
4. **多库回退** - 支持3种PDF解析库，提高转换成功率

---

## 环境要求

### Python版本
- Python 3.10+

### 依赖安装

```bash
pip install pandas pdfplumber requests openpyxl

# 推荐安装备用库（提高PDF转换兼容性）
pip install PyPDF2 pdfminer.six
```

---

## 配置说明

脚本底部的“配置区域”包含所有可调参数：

### 模式选择

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `RUN_MODE` | 运行模式（`download` 或 `convert_only`） | `download` |

### 核心配置

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `EXCEL_FILE` | 年报链接Excel文件路径 | `年报链接_2024【公众号：凌小添】.xlsx` |
| `DELETE_PDF` | 转换后是否删除PDF | `False` |
| `BATCH_MODE` | 是否批量处理多年份 | `True` |

### 年份配置

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `START_YEAR` | 批量模式起始年份 | `2022` |
| `END_YEAR` | 批量模式结束年份 | `2024` |
| `SINGLE_YEAR` | 单独模式指定年份 | `2023` |

### 下载配置

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `MAX_RETRIES` | 下载失败最大重试次数 | `3` |
| `TIMEOUT` | HTTP请求超时（秒） | `15` |
| `PROCESSES` | 并行进程数（`None`=自动） | `None` |

---

## Excel文件格式要求

Excel文件必须包含以下列：

| 列名 | 说明 | 示例 |
|------|------|------|
| `公司代码` | 6位股票代码 | `600519` |
| `公司简称` | 公司名称 | `贵州茅台` |
| `年份` | 年报年份 | `2023` |
| `年报链接` | PDF下载URL | `http://...` |

---

## 使用方法

### 方式A：命令行方式（推荐）

无参数运行会输出帮助：

```bash
python3 2.pdf_batch_converter.py
```

下载+转换（单一年份）：

```bash
python3 2.pdf_batch_converter.py download --excel-file "你的表.xlsx" --year 2023
```

下载+转换（批量年份）：

```bash
python3 2.pdf_batch_converter.py download --excel-file "你的表.xlsx" --start-year 2022 --end-year 2024
```

纯转换模式请参考：`docs/convert_only_mode_user_guide.md`

### 方式B：修改脚本底部配置（兼容旧用法）

编辑脚本底部配置区域，然后运行：

```python
# 指定Excel文件路径
EXCEL_FILE = "res/AnnualReport_links_2004_2023.xlsx"

# 设置年份范围
START_YEAR = 2020
END_YEAR = 2023

# 磁盘空间有限时可开启
DELETE_PDF = True
```

运行：

```bash
python3 2.pdf_batch_converter.py --use-config
```

### 查看输出

处理完成后，文件结构如下：

```
年报文件/
├── 2022/
│   ├── pdf年报/
│   │   ├── 600519_贵州茅台_2022.pdf
│   │   └── ...
│   └── txt年报/
│       ├── 600519_贵州茅台_2022.txt
│       └── ...
├── 2023/
│   ├── pdf年报/
│   └── txt年报/
└── ...
```

---

## 运行日志示例

```
============================================================
年报批量下载转换程序启动
目标年份: 2023
删除PDF: False
============================================================
成功加载Excel文件: res/AnnualReport_links_2004_2023.xlsx
目录准备完成: PDF=年报文件/2023/pdf年报, TXT=年报文件/2023/txt年报
找到 5200 条 2023 年的记录
使用 8 个进程处理 5200 个文件
PDF 下载成功: 年报文件/2023/pdf年报/600519_贵州茅台_2023.pdf
转换成功 (pdfplumber): 年报文件/2023/txt年报/600519_贵州茅台_2023.txt
============================================================
处理完成: 成功 5198/5200
============================================================
```

---

## PDF转换回退机制

当主库转换失败时，自动尝试备用库：

```
pdfplumber（默认） → PyPDF2（备用1） → pdfminer.six（备用2）
```

确保安装所有库以获得最高转换成功率。

---

## 常见问题

### Q1: 提示"403 Forbidden"
**原因**: 服务器限制访问频率或IP被临时封禁
**解决**: 等待一段时间后重试，或更换网络环境

### Q2: 转换失败"所有PDF转换方法均失败"
**原因**: PDF文件损坏或为扫描件
**解决**: 确认PDF可正常打开，扫描件无法直接转换为文本

### Q3: 内存不足
**原因**: 进程数过多
**解决**: 设置 `PROCESSES = 4` 限制并发数

### Q4: 文件已存在提示跳过
**说明**: 这是正常行为，脚本会自动跳过已转换的文件，支持断点续传

---

## 注意事项

1. **磁盘空间** - 单年年报约需 50-100GB（PDF+TXT）
2. **网络稳定** - 下载过程需保持网络连接
3. **断点续传** - 中断后重新运行会自动跳过已处理文件
4. **备用库** - 强烈建议安装 PyPDF2 和 pdfminer.six 提高兼容性
