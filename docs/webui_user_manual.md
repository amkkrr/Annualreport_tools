# 年报分析工具箱 WebUI 用户手册

## 1. 功能概述

**年报分析工具箱 WebUI** 是一个基于 Streamlit 构建的可视化管理界面，旨在简化上市公司年报的下载、PDF 转换、文本提取及分析流程。通过 WebUI，用户可以无需接触命令行即可完成全流程的数据处理和监控。

主要功能包括：
*   **可视化监控**：实时查看数据处理进度、各阶段队列状态及关键指标。
*   **配置管理**：图形化编辑系统配置文件 (`config.yaml`)，灵活调整爬取范围和并发参数。
*   **任务调度**：一键启动、停止和监控后台爬虫、转换器及提取器任务。
*   **数据浏览**：智能筛选年报，查看各阶段处理状态，并支持对异常任务进行批量重置和重试。

---

## 2. 环境要求与启动方式

### 2.1 环境要求

*   **操作系统**: Linux / macOS / Windows
*   **Python 版本**: 3.9+
*   **数据库支持**:
    *   **SQLite** (`data/metadata.db`): 用于存储公司元数据、报告状态及 WebUI 任务队列（系统自动维护）。
    *   **DuckDB** (`data/annual_reports.duckdb`): 用于存储深度的文本分析数据（如 MDA 内容）。

### 2.2 安装依赖

首次使用前，请确保已安装 WebUI 所需的 Python 依赖库。在项目根目录下运行：

```bash
pip install -r webui/requirements.txt
```

### 2.3 启动 WebUI

在项目根目录下执行以下命令启动服务：

```bash
streamlit run webui/app.py
```

启动成功后，浏览器通常会自动打开 `http://localhost:8501`。如果未自动打开，请手动访问该地址。

---

## 3. 各页面功能详解

WebUI 左侧侧边栏提供了四个主要功能页面的导航菜单。

### 3.1 监控仪表盘 (Dashboard)

**功能**: 提供系统的全局概览，帮助用户快速了解当前运行状态。

*   **关键指标区域**:
    *   **待下载**: 爬虫已获取链接但尚未下载 PDF 的报告数量。
    *   **待转换**: 已下载 PDF 但尚未转换为文本的报告数量。
    *   **待审核 MDA**: 提取质量较低或存在潜在问题，建议人工复核的记录。
    *   **已完成提取**: 成功完成所有处理步骤的报告总数。
*   **年度处理进度**: 以表格形式展示各年份的下载、转换、提取成功率和完成情况。
*   **待处理队列**: 分页展示当前积压的任务详情（如下载队列、转换队列），支持查看前 100 条记录。
*   **刷新**: 点击"刷新数据"按钮可即时更新所有统计信息。

### 3.2 配置管理 (Configuration)

**功能**: 提供 `config.yaml` 文件的可视化编辑界面，修改后即时生效。

*   **爬虫配置**:
    *   **目标年份**: 勾选需要爬取的年报年份（支持多选）。
    *   **目标板块**: 选择沪市主板、深市主板、创业板或科创板。
    *   **排除关键词**: 设置标题过滤词（每行一个），如"摘要"、"英文版"等，包含这些词的报告将被跳过。
*   **下载与转换配置**:
    *   **下载并发进程数**: 设置同时下载 PDF 的进程数量（建议 4-8）。
    *   **转换并发进程数**: 设置 PDF 转文本的并行处理能力（建议根据 CPU 核心数调整）。
*   **MDA 提取配置**:
    *   **提取并发进程数**: 设置文本分析的并发数。
    *   **增量模式**: 勾选后，系统仅处理未完成或状态为 pending 的报告；取消勾选则强制重新处理所有报告。

### 3.3 任务管理 (Task Manager)

**功能**: 系统的中央控制台，用于管理后台数据处理流水线。

*   **任务控制面板**:
    *   包含 **爬取链接**、**下载转换**、**提取 MDA** 三大核心任务。
    *   每个任务模块提供 **启动** 和 **停止** 按钮。
    *   **状态指示灯**: 实时显示任务状态（🟢 运行中 / ⚪ 已停止 / 🔴 错误）。
*   **任务日志**:
    *   底部区域实时显示各任务的控制台输出日志，便于排查错误。
    *   勾选"自动刷新"可每 5 秒更新一次日志视图。

### 3.4 年报浏览器 (Report Browser)

**功能**: 强大的数据查询与运维工具，用于查找特定年报并修正状态。

*   **侧边栏筛选**:
    *   **搜索**: 输入股票代码或公司简称进行模糊查找。
    *   **行业**: 按证监会行业分类进行筛选。
    *   **年份范围**: 滑动滑块选择特定的年份区间。
    *   **状态筛选**: 精确查找在 下载/转换/提取 任一阶段处于 pending（待处理）、success（成功）或 failed（失败）的记录。
*   **数据列表与操作**:
    *   主界面展示符合筛选条件的年报列表。
    *   **复选框选择**: 勾选列表左侧的复选框选中特定记录。
    *   **批量重置状态**: 页面底部提供三个重置按钮。例如，若某批年报转换失败，可勾选后点击"重置转换状态"，将其状态改回 `pending`，系统随后会自动重试。

---

## 4. 常见操作流程示例

### 流程一：启动新一轮数据抓取

1.  **配置范围**: 进入"配置管理"，确保"目标年份"包含当前年份（如 2024）。点击"保存配置"。
2.  **启动爬虫**: 进入"任务管理"，点击"爬取链接"卡片下的 **启动** 按钮。
3.  **监控进度**: 在"任务日志"中确认爬虫开始工作。待爬取完成后（或同时），点击"下载转换"的 **启动** 按钮，开始并行下载和处理 PDF。

### 流程二：修复失败的任务

1.  **定位失败项**: 进入"年报浏览器"。
2.  **筛选**: 在侧边栏将"转换状态"设置为 `failed`，点击"查询"。
3.  **批量重置**: 勾选查询结果中的所有记录（或表头全选）。
4.  **执行重置**: 点击底部的 **重置转换状态** 按钮。
5.  **重新运行**: 回到"任务管理"，确保"下载转换"任务处于"运行中"状态，系统将自动重新处理刚才重置的记录。

---

## 5. 常见问题解答 (FAQ)

**Q: 启动任务后，状态显示"运行中"，但日志区为空或不更新？**
A: 请点击日志区上方的"刷新日志"按钮。如果仍无内容，请检查运行 WebUI 的终端窗口是否有 Python 报错信息。

**Q: 为什么"年报浏览器"里搜不到某个公司？**
A: WebUI 仅展示数据库中已有的记录。请先确认"爬取链接"任务是否已运行，且配置的年份和板块覆盖了该公司的范围。

**Q: 修改了配置（如排除关键词），需要重启 WebUI 吗？**
A: 不需要重启 WebUI。点击"保存配置"后，配置即写入文件。但建议**停止并重启**正在运行的后台任务（如爬虫或转换器），以确保新任务加载最新的配置参数。

**Q: 数据库文件存放在哪里？**
A: 所有数据默认存储在项目根目录的 `data/` 文件夹下。WebUI 主要读取 `data/metadata.db` (SQLite) 进行展示。
