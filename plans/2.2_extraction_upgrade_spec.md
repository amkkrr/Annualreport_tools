---
task_id: phase-2.2-extraction-upgrade
type: FEAT
complexity: S
current_phase: completed
completed_phases: [P0, P1, P2, P4]
branch: null
audit_iteration: 0
created_at: 2026-01-10
updated_at: 2026-01-10
---

# Phase 2.2 精准提取策略升级 - 剩余任务规划

## 问题定义 (P0)

**类型**: FEAT-S

**背景**: Phase 2.2 的核心优化（策略迭代，平均分 68.86 → 96.51）已完成。剩余三项增强功能需要规划实现。

**范围**:

### 做

1. **目录页解析强校验 (TOC Parsing)** - `P1`
   - 现有 `parse_toc_for_page_range` 已能解析目录页
   - 需要增强：当 TOC 命中时，增加与正文提取结果的交叉校验
   - 目标：提高定位准确性，减少误提取

2. **PDF 书签读取 (Outlines)** - `P2`
   - 在 PDF 转换阶段读取 PDF 内置书签（Outlines）
   - 将书签信息保存到元数据，供提取阶段使用
   - 作为加分项，非主策略

3. **字段切分** - `P2`
   - 将 MD&A 文本自动切分为"经营回顾"与"未来展望"两个子字段
   - 可选增强，根据实际需求决定实现深度

### 不做

- 重写现有提取策略（已经达到 96.51 分）
- LLM 辅助提取（属于 Phase 2.5 范畴）
- 质量评分闭环（属于 Phase 2.3 范畴）

**完成标准**:

| ID | 验收项 | Given | When | Then |
|----|--------|-------|------|------|
| 2.2-01 | TOC 强校验 | 目录页有 MD&A 页码 | 提取完成 | `used_rule_type` 包含 TOC 校验标记 |
| 2.2-02 | TOC 不一致警告 | TOC 页码与正文定位差异 > 2 页 | 提取完成 | `quality_flags` 包含 `FLAG_TOC_MISMATCH` |
| 2.2-03 | PDF 书签读取 | PDF 有内置书签 | 执行转换 | 书签信息写入元数据文件或数据库 |
| 2.2-04 | 字段切分 | MD&A 包含"展望"类关键词 | 提取完成 | `mda_sections` 字段有 `review` 和 `outlook` 子字段 |

---

## 现状分析

### 1. TOC 解析现状

`strategies.py:328-391` 已实现 `parse_toc_for_page_range`:

```python
def parse_toc_for_page_range(
    pages: Sequence[str],
    *,
    page_numbers: Optional[Sequence[Optional[int]]] = None,
    scan_pages: int = 15,
) -> Optional[TocHit]:
```

**功能**:
- 扫描前 15 页识别目录页
- 提取 MD&A 标题对应的印刷页码
- 映射印刷页码到实际页索引

**当前使用方式** (`extract_mda_iterative`):
- TOC 提取结果作为候选之一
- 与 custom rule、body 提取结果竞争
- 按 score 排序选择最佳结果

**待增强**:
- TOC 结果与正文提取结果的交叉校验
- 不一致时的警告标记

### 2. PDF 书签现状

当前 PDF 处理流程 (`2.pdf_batch_converter.py`):
1. 下载 PDF
2. 使用 pdfplumber/PyPDF2/pdfminer 转换为 TXT
3. TXT 文件不包含书签信息

**待实现**:
- 在转换阶段读取 PDF Outlines
- 保存书签结构（标题 + 页码映射）

### 3. 字段切分现状

当前 `mda_raw` 是完整的 MD&A 文本，无子字段切分。

**可行方案**:
- 基于关键词识别"展望"/"未来"等子章节
- 切分为 `review`（经营回顾）和 `outlook`（未来展望）

---

## 待调研问题

1. **TOC 校验策略**: TOC 与正文结果不一致时，应该信任哪个？还是标记让用户人工审核？
2. **PDF 书签覆盖率**: 实际年报 PDF 有多少包含有用的书签？（需要采样验证）
3. **字段切分边界**: "经营回顾"和"未来展望"的边界如何定义？是否有标准的子标题格式？

---

## 技术调研 (P1)

### 1. TOC 校验策略

**调研结论**:

当前 `extract_mda_iterative` 已经将 TOC 结果与正文结果放在同一个候选池中竞争，但缺少交叉校验机制。

**推荐方案**:
- 当 TOC 命中且正文也命中时，比较两者的页码范围
- 如果差异 ≤ 2 页：认为一致，选择 score 更高的结果
- 如果差异 > 2 页：添加 `FLAG_TOC_MISMATCH` 标记，但仍选择 score 更高的结果
- 这样既保持了自动化，又为人工审核提供了线索

**改动范围**:
- `strategies.py`: 修改 `extract_mda_iterative` 函数
- 新增交叉校验逻辑
- 影响文件数: 1

### 2. PDF 书签可行性

**技术调研**:

| 库 | 书签读取支持 | API |
|----|-------------|-----|
| PyPDF2 | ✓ 支持 | `reader.outline` 或 `reader.outlines` |
| pdfplumber | ✗ 不直接支持 | 需要通过 pdfminer 底层 API |
| pdfminer | ✓ 支持 | `PDFDocument.get_outlines()` |

**推荐方案**:
- 在 `_convert_with_pypdf2` 中添加书签读取
- 将书签保存为 JSON sidecar 文件（如 `xxx.pdf.outlines.json`）
- 或写入数据库 `reports` 表的新字段 `pdf_outlines`

**覆盖率预估**:
- 需要实际采样验证，但根据经验，正规年报 PDF 通常有内置书签
- 作为"加分项"，即使覆盖率低也不影响主流程

**改动范围**:
- `2.pdf_batch_converter.py`: 修改 `PDFToTextConverter` 类
- 可选：`annual_report_mda/db.py`: 新增字段
- 影响文件数: 1-2

### 3. 字段切分边界

**调研结论**:

中国年报 MD&A 常见子标题格式：

**经营回顾类**:
- "一、报告期内公司所从事的主要业务..."
- "（一）主营业务分析"
- "1、主要业务情况"
- "公司主要业务情况"

**未来展望类**:
- "未来发展展望"
- "公司发展战略"
- "下一年度经营计划"
- "未来发展的展望"
- "公司未来发展战略及规划"
- "对公司未来发展的展望"

**推荐方案**:
- 使用正则匹配识别"展望"/"未来"/"发展战略"等关键词
- 找到第一个匹配位置作为切分点
- 前半部分为 `review`，后半部分为 `outlook`
- 如果未找到切分点，`outlook` 为 null

**改动范围**:
- 新增 `annual_report_mda/section_splitter.py` 模块
- 修改 `data_manager.py`: 新增 `mda_review` 和 `mda_outlook` 字段
- 影响文件数: 2-3

---

## 设计规格 (P2)

### 1. TOC 强校验

**接口设计**:

```python
# strategies.py 新增

@dataclass(frozen=True)
class ExtractionResult:
    # ... 现有字段 ...
    toc_page_mismatch: Optional[int] = None  # TOC 与正文页码差异

def _cross_validate_toc_and_body(
    toc_result: Optional[ExtractionResult],
    body_result: Optional[ExtractionResult],
) -> tuple[Optional[ExtractionResult], list[str]]:
    """
    交叉校验 TOC 和正文提取结果。

    Returns:
        (最佳结果, 额外的 quality_flags)
    """
```

**校验规则**:

| 场景 | TOC 结果 | 正文结果 | 处理 |
|------|---------|---------|------|
| 仅 TOC | ✓ | ✗ | 使用 TOC |
| 仅正文 | ✗ | ✓ | 使用正文 |
| 两者一致 | ✓ | ✓ | 选 score 高者 |
| 两者不一致 | ✓ | ✓ | 选 score 高者 + FLAG_TOC_MISMATCH |

### 2. PDF 书签读取

**接口设计**:

```python
# 2.pdf_batch_converter.py 新增

@dataclass(frozen=True)
class PDFOutlineEntry:
    title: str
    page_number: Optional[int]
    level: int  # 层级深度

@dataclass(frozen=True)
class PDFConversionResult:
    success: bool
    backend: Optional[str] = None
    error: Optional[str] = None
    outlines: Optional[list[PDFOutlineEntry]] = None  # 新增

def _extract_outlines_pypdf2(pdf_path: Path) -> Optional[list[PDFOutlineEntry]]:
    """从 PDF 提取书签（仅 PyPDF2）。"""
```

**存储方案**:
- 方案 A：JSON sidecar 文件（`xxx.pdf.outlines.json`）
- 方案 B：数据库字段（`reports.pdf_outlines` JSON 类型）

**推荐**: 方案 B，便于查询和统一管理。

### 3. 字段切分

**接口设计**:

```python
# annual_report_mda/section_splitter.py 新建

@dataclass(frozen=True)
class MdaSections:
    review: str  # 经营回顾部分
    outlook: Optional[str]  # 未来展望部分
    split_keyword: Optional[str]  # 触发切分的关键词
    split_position: Optional[int]  # 切分位置（字符偏移）

def split_mda_sections(mda_text: str) -> MdaSections:
    """
    将 MD&A 文本切分为经营回顾和未来展望两部分。

    Args:
        mda_text: 完整的 MD&A 文本

    Returns:
        MdaSections 对象
    """
```

**切分关键词** (按优先级排序):

```python
OUTLOOK_KEYWORDS = [
    r"第[一二三四五六七八九十\d]+[章节部分].*未来",
    r"第[一二三四五六七八九十\d]+[章节部分].*展望",
    r"[一二三四五六七八九十\d]+[、.].*未来发展",
    r"[一二三四五六七八九十\d]+[、.].*发展展望",
    r"[（\(][一二三四五六七八九十\d]+[）\)].*未来",
    r"公司未来发展",
    r"发展战略",
    r"未来展望",
]
```

**数据库字段**:

```sql
-- mda_text 表新增字段
ALTER TABLE mda_text ADD COLUMN mda_review TEXT;
ALTER TABLE mda_text ADD COLUMN mda_outlook TEXT;
ALTER TABLE mda_text ADD COLUMN outlook_split_position INTEGER;
```

---

## 实现清单 (P4)

### Step 1: TOC 强校验 (P1 优先级)

- [ ] 修改 `strategies.py`: 在 `extract_mda_iterative` 中添加交叉校验逻辑
- [ ] 添加 `FLAG_TOC_MISMATCH` 到 `quality_flags`
- [ ] 更新单元测试

### Step 2: PDF 书签读取 (P2 优先级)

- [ ] 修改 `2.pdf_batch_converter.py`: 添加 `_extract_outlines_pypdf2` 函数
- [ ] 修改 `PDFConversionResult`: 添加 `outlines` 字段
- [ ] 修改数据库 schema: 添加 `reports.pdf_outlines` 字段
- [ ] 更新转换流程保存书签信息

### Step 3: 字段切分 (P2 优先级)

- [ ] 新建 `annual_report_mda/section_splitter.py`
- [ ] 修改数据库 schema: 添加 `mda_review`, `mda_outlook` 字段
- [ ] 修改 `mda_extractor.py`: 调用切分逻辑
- [ ] 更新 `data_manager.py`: 保存切分结果

---

## 下一步

请确认此规划方案，然后进入实现阶段。

**优先建议**:
1. 先实现 TOC 强校验（P1），因为改动小且价值明确
2. 字段切分（P2）可根据下游分析需求决定是否实现
3. PDF 书签（P2）作为加分项，可延后或跳过
