---
task_id: m2.5-mda-enhancement
type: FEAT
complexity: S
current_phase: P0
completed_phases: []
branch: null
audit_iteration: 0
created_at: 2026-01-11
updated_at: 2026-01-11
---

# Phase 2.5: MD&A 提取器增强 — 规格书

## 问题定义 (P0)

**类型**: FEAT-S (标准新功能)

**背景**: Phase 2.5 是 MD&A 提取器增强阶段，核心目标是完善测试覆盖、质检能力。本阶段聚焦于 2.5.1 和 2.5.2 高优先级任务，LLM 自适应学习 (2.5.4) 作为 P2 优先级延后。

**范围**:

**做**:
- 2.5.1 端到端测试验证（高优先）
  - [ ] `P1` 编写 `calculate_mda_score` 单元测试，覆盖各评分维度
  - [ ] `P1` 编写 `extract_mda_iterative` 单元测试，验证迭代策略逻辑
  - [ ] `P1` 创建集成测试：端到端跑测 + 增量逻辑验证
  - [ ] `P1` 准备 Mock 数据集：含/不含目录、含/不含页分隔符的样本
- 2.5.2 质检增强
  - [ ] `P1` 实现 L3 时序校验（FLAG_YOY_CHANGE_HIGH），检测年际变化异常
  - [ ] `P1` 创建质检 SQL 视图 `mda_text_latest`（已存在），验证功能正确性
- 2.5.3 文档更新
  - [ ] `P1` 更新主 README.md，补充 `mda_extractor.py` 完整使用说明（已完成大部分）
  - [ ] `P2` 编写开发者指南，说明策略扩展方式

**不做** (延后到 M3/M4):
- 2.5.4 LLM 自适应学习（Self-Refine、动态 Few-shot、策略权重自适应）—— P2 优先级
- 合并分支工作（当前在 main 分支开发）

**完成标准**:
- [ ] `pytest tests/test_mda_*.py -v` 全部通过
- [ ] `annual_report_mda/` 模块覆盖率 ≥ 70%
- [ ] 全部单测运行 < 30s
- [ ] L3 时序校验功能可用，数据库支持 FLAG_YOY_CHANGE_HIGH 检测

---

## P1: 技术调研

### 1.1 现有测试覆盖分析

**已有测试文件**:
| 文件 | 覆盖模块 | 测试数量 | 备注 |
|------|---------|---------|------|
| `tests/test_scorer.py` | `scorer.py` | 27 测试 | 覆盖负向特征检测、质量评分 |
| `tests/test_duckdb_core.py` | `db.py` | 若干 | DuckDB 核心功能 |
| `tests/test_m2_verification.py` | M2 验收 | 若干 | M2 里程碑验收测试 |

**缺失测试**:
| 模块 | 关键函数 | 优先级 |
|------|---------|--------|
| `strategies.py` | `calculate_mda_score` | P1 |
| `strategies.py` | `extract_mda_iterative` | P1 |
| `strategies.py` | `parse_toc_for_page_range` | P1 |
| `mda_extractor.py` | `_extract_one_worker` | P1 |
| `mda_extractor.py` | 增量逻辑 | P1 |
| `section_splitter.py` | 字段切分 | P2 |
| `text_loader.py` | 页加载 | P2 |

### 1.2 L3 时序校验设计

**功能定义**: 检测同一公司连续年份 MD&A 文本变化是否异常

**触发条件**:
- 同一 `stock_code` 存在 `year` 和 `year-1` 两年数据
- 文本相似度（Jaccard 或余弦相似度）低于阈值（如 < 0.3）

**实现位置**:
- `scorer.py`: 新增 `detect_yoy_change()` 函数
- 调用时机：`calculate_quality_score()` 或单独的质检脚本

**数据依赖**:
```sql
-- 查询同公司相邻年份数据
SELECT m1.stock_code, m1.year, m1.mda_raw, m2.mda_raw AS prev_mda_raw
FROM mda_text_latest m1
JOIN mda_text_latest m2
  ON m1.stock_code = m2.stock_code
  AND m1.year = m2.year + 1;
```

### 1.3 Mock 数据集设计

**样本类型**:
| 类型 | 文件名模式 | 特征 |
|------|-----------|------|
| 带目录 | `mock_with_toc.txt` | 含 `目录` + 引导线 `......` |
| 无目录 | `mock_no_toc.txt` | 无目录页 |
| Form Feed 分页 | `mock_ff_pages.txt` | 使用 `\f` 分隔 |
| 等号分页 | `mock_eq_pages.txt` | 使用 `=== Page N ===` |
| 混合分页 | `mock_mixed_pages.txt` | 混合分隔符 |
| 无分页 | `mock_no_pages.txt` | 无任何分隔符 |
| 边界异常 | `mock_edge_cases.txt` | 空文件、超长、乱码 |

**存放位置**: `tests/fixtures/mock_mda/`

---

## P2: 设计规格

### 2.1 测试架构

```
tests/
├── fixtures/
│   └── mock_mda/                    # Mock 数据集
│       ├── mock_with_toc.txt
│       ├── mock_no_toc.txt
│       ├── mock_ff_pages.txt
│       └── ...
├── test_scorer.py                   # 现有 - 评分器测试
├── test_strategies.py               # 新增 - 提取策略测试
├── test_mda_extractor.py            # 新增 - 提取器单元测试
├── test_mda_integration.py          # 新增 - 端到端集成测试
└── test_yoy_validator.py            # 新增 - L3 时序校验测试
```

### 2.2 关键测试用例设计

#### 2.2.1 `test_strategies.py` — 提取策略测试

| 测试函数 | 测试场景 | 输入 | 预期 |
|---------|---------|------|------|
| `test_calculate_mda_score_empty` | 空文本 | `""` | `score=0.0` |
| `test_calculate_mda_score_short` | 短文本 | `"短"*100` | `score=0.0` |
| `test_calculate_mda_score_with_keywords` | 含关键词 | 含"收入/同比/毛利率" | `score > 0.5` |
| `test_calculate_mda_score_with_dots` | 目录引导线 | 含大量`......` | `dots_count >= 10` |
| `test_extract_mda_iterative_with_toc` | TOC 提取 | mock_with_toc.txt | `used_rule_type="toc"` |
| `test_extract_mda_iterative_generic` | 正文提取 | mock_no_toc.txt | `used_rule_type="generic"` |
| `test_extract_mda_iterative_custom` | 自定义规则 | 带 custom_start_pattern | `used_rule_type="custom"` |
| `test_extract_mda_iterative_fail` | 提取失败 | 无 MD&A 标题 | `return None` |
| `test_parse_toc_for_page_range` | TOC 解析 | mock_with_toc.txt | 返回 TocHit |
| `test_toc_mismatch_flag` | TOC/正文不一致 | 页码差 > 2 | `FLAG_TOC_MISMATCH` |

#### 2.2.2 `test_mda_extractor.py` — 提取器单元测试

| 测试函数 | 测试场景 | 输入 | 预期 |
|---------|---------|------|------|
| `test_infer_stock_year_from_filename` | 文件名解析 | `600519_贵州茅台_2023.txt` | `("600519", 2023)` |
| `test_infer_stock_year_from_dir` | 目录解析 | `000778/2023.txt` | `("000778", 2023)` |
| `test_infer_stock_year_fail` | 解析失败 | `invalid.txt` | `(None, None)` |
| `test_extract_one_worker_success` | 成功提取 | 有效 payload | `ok=True, record!=None` |
| `test_extract_one_worker_fail` | 提取失败 | 无 MD&A 文本 | `ok=True, quality_flags=["FLAG_EXTRACT_FAILED"]` |

#### 2.2.3 `test_mda_integration.py` — 端到端集成测试

| 测试函数 | 测试场景 | 给定 | 当 | 则 |
|---------|---------|------|-----|-----|
| `test_end_to_end_single_file` | 单文件流程 | 测试 DB + mock 文件 | 执行 main([...]) | DB 有记录 |
| `test_incremental_skip` | 增量跳过 | 已入库记录 | 再次执行 --incremental | 跳过，不重复处理 |
| `test_dry_run_no_write` | dry-run | --dry-run 模式 | 执行完成 | DB 无记录 |

#### 2.2.4 `test_yoy_validator.py` — L3 时序校验测试

| 测试函数 | 测试场景 | 输入 | 预期 |
|---------|---------|------|------|
| `test_yoy_similar_texts` | 相似文本 | 两年文本相似度 > 0.7 | 无 FLAG |
| `test_yoy_different_texts` | 差异文本 | 两年文本相似度 < 0.3 | `FLAG_YOY_CHANGE_HIGH` |
| `test_yoy_missing_prev_year` | 缺少上年 | 仅有当年数据 | 跳过校验 |

### 2.3 L3 时序校验接口

```python
# annual_report_mda/scorer.py

def calculate_text_similarity(text1: str, text2: str) -> float:
    """
    计算两段文本的相似度 (Jaccard Index)。

    Args:
        text1: 文本 1
        text2: 文本 2

    Returns:
        相似度 0.0-1.0
    """
    ...

def detect_yoy_change(
    current_text: str,
    prev_text: str | None,
    *,
    similarity_threshold: float = 0.3,
) -> tuple[bool, float]:
    """
    检测年际变化是否异常。

    Args:
        current_text: 当年 MD&A 文本
        prev_text: 上年 MD&A 文本（None 表示无上年数据）
        similarity_threshold: 相似度阈值，低于此值触发 FLAG

    Returns:
        (is_abnormal, similarity_score)
    """
    ...
```

### 2.4 Mock 数据集内容规格

#### `mock_with_toc.txt`
```
目 录

第一节 重要提示、目录和释义 ...................... 1
第二节 公司简介和主要财务指标 .................... 5
第三节 管理层讨论与分析 .......................... 10
第四节 公司治理 .................................. 25
第五节 财务报告 .................................. 30

=== Page 10 ===

第三节 管理层讨论与分析

一、报告期内公司所处行业情况

公司主营业务收入同比增长 15%，毛利率保持稳定在 35%。
现金流充裕，行业展望良好。

=== Page 11 ===

二、报告期内主要经营情况

本报告期，公司实现营业收入 100 亿元，同比增长 10%。

=== Page 25 ===

第四节 公司治理

...
```

#### `mock_no_toc.txt`
```
=== Page 1 ===

公司简介

股票代码：600519
公司名称：贵州茅台

=== Page 5 ===

第三节 管理层讨论与分析

一、报告期内公司所处行业情况

公司主营业务收入同比增长 20%，毛利率提升至 40%。

=== Page 10 ===

第四节 公司治理

...
```

---

## 实现清单

### Step 1: 测试基础设施 (优先)

- [ ] 创建 `tests/fixtures/mock_mda/` 目录
- [ ] 编写 Mock 数据文件（6 种场景）
- [ ] 创建 `tests/conftest.py` 共享 fixtures

### Step 2: 策略测试 (`test_strategies.py`)

- [ ] 编写 `calculate_mda_score` 测试 (5 用例)
- [ ] 编写 `extract_mda_iterative` 测试 (5 用例)
- [ ] 编写 `parse_toc_for_page_range` 测试 (3 用例)
- [ ] 验证覆盖率 ≥ 70%

### Step 3: 提取器测试 (`test_mda_extractor.py`)

- [ ] 编写 `_infer_stock_year` 测试 (3 用例)
- [ ] 编写 `_extract_one_worker` 测试 (2 用例)

### Step 4: 集成测试 (`test_mda_integration.py`)

- [ ] 编写端到端测试 (3 用例)
- [ ] 使用临时数据库避免污染

### Step 5: L3 时序校验

- [ ] 实现 `calculate_text_similarity()` 函数
- [ ] 实现 `detect_yoy_change()` 函数
- [ ] 编写 `test_yoy_validator.py` (3 用例)
- [ ] 集成到质量评分流程（可选）

### Step 6: 文档更新

- [ ] 确认 README.md 中 mda_extractor.py 说明完整
- [ ] 补充开发者策略扩展指南（可选 P2）

---

## 验收标准

### 功能验收（必须通过）

| ID | 验收项 | Given | When | Then | 状态 |
|----|--------|-------|------|------|------|
| M2.5-01 | 评分单测 | 测试用例准备完毕 | 执行 `pytest tests/test_scorer.py` | 所有测试通过，覆盖率 ≥ 80% | ⏳ |
| M2.5-02 | 策略单测 | Mock 数据准备完毕 | 执行 `pytest tests/test_strategies.py` | 含/不含目录样本均正确处理 | ⏳ |
| M2.5-03 | 提取器单测 | 测试用例准备完毕 | 执行 `pytest tests/test_mda_extractor.py` | 文件名解析、提取逻辑正确 | ⏳ |
| M2.5-04 | 集成测试 | 测试数据库初始化 | 执行端到端测试 | 增量逻辑正确，已处理文件不重复提取 | ⏳ |
| M2.5-05 | 时序校验 | 同一公司连续两年 MDA 文本 | 执行质检 | 正确识别 FLAG_YOY_CHANGE_HIGH | ⏳ |

### 质量验收（建议通过）

| ID | 验收项 | 指标 | 状态 |
|----|--------|------|------|
| M2.5-Q1 | 单测覆盖率 | `annual_report_mda/` 模块覆盖率 ≥ 70% | ⏳ |
| M2.5-Q2 | 测试执行时间 | 全部单测运行 < 30s | ⏳ |
| M2.5-Q3 | 文档完整性 | README 包含快速开始、参数说明、输出格式 | ⏳ |

### 测试命令

```bash
# 运行 M2.5 相关测试
pytest tests/test_mda_*.py tests/test_strategies.py -v

# 运行评分器单测
pytest tests/test_scorer.py -v --cov=annual_report_mda.scorer

# 运行策略单测
pytest tests/test_strategies.py -v --cov=annual_report_mda.strategies

# 运行提取器单测
pytest tests/test_mda_extractor.py -v

# 端到端集成测试
pytest tests/test_mda_integration.py -v

# 全模块覆盖率
pytest tests/ -v --cov=annual_report_mda --cov-report=html
```

---

## 风险与依赖

### 风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| Mock 数据不足以覆盖真实场景 | 测试遗漏边界 | 从黄金数据集抽取真实样本 |
| L3 时序校验计算量大 | 性能问题 | 使用增量计算，仅校验新入库数据 |
| 测试与实现耦合过紧 | 维护成本高 | 使用接口测试，避免内部实现细节 |

### 依赖

- 依赖 M2 已完成的质量评分体系
- 依赖 DuckDB `mda_text` 表结构
- 依赖 `pytest`, `pytest-cov` 测试工具

---

## 附录: 现有模块分析

### scorer.py 关键函数

| 函数 | 功能 | 测试覆盖 |
|------|------|---------|
| `calculate_mda_score()` | 计算文本像 MD&A 的程度 | ✅ `test_scorer.py` |
| `detect_table_residue()` | 检测表格残留 | ✅ |
| `detect_header_noise()` | 检测页眉干扰 | ✅ |
| `calculate_garbled_ratio()` | 计算乱码比例 | ✅ |
| `detect_negative_features()` | 综合负向特征 | ✅ |
| `calculate_quality_score()` | 综合质量评分 | ✅ |

### strategies.py 关键函数

| 函数 | 功能 | 测试覆盖 |
|------|------|---------|
| `extract_mda_iterative()` | 多策略迭代提取 | ❌ 缺失 |
| `extract_mda_from_pages()` | 正文扫描提取 | ❌ 缺失 |
| `parse_toc_for_page_range()` | TOC 页码解析 | ❌ 缺失 |
| `_try_extract_with_custom_rule()` | 自定义规则提取 | ❌ 缺失 |
| `_is_toc_page()` | TOC 页检测 | ❌ 缺失 |
| `_looks_like_heading()` | 标题行检测 | ❌ 缺失 |
